/*!
  webmd.m.newsletter.js
  Â© 2011, WebMD
  $Id: newsletter.js 4751 2011-03-30 21:28:27Z ialexander $

*/
window.webmd||(webmd={}),webmd.m||(webmd.m={}),webmd.m.newsletter={Module:function(){}},webmd.m.newsletter.Module.prototype={serviceUrl:"https://www"+webmd.url.getEnv()+".webmd.com/api/reg/regapi.svc/jsonp/subscribe",timeoutSeconds:15,selectors:{title:".newsletterTitle",text:".newsletterText",form:"form",inputEmail:"input[name=email]",inputNls:"input:hidden[name=nls]",inputCbs:"input:checkbox[name=nls]",inputPrivacy:"input:checkbox[name=privacy]",submit:"button[name=submit]"},dataSelectors:!1,omnitureModule:"nl",omnitureAppend:"",dataVar:"newsletter",classes:{noChange:"newsletterNoChange",label:"newsletterLabel",error:"newsletterError"},msg:{noEmail:"Please enter your email address.",badEmail:"Please check that you entered a valid email address.",checkbox:"Please select a newsletter.",privacy:"Please acknowledge your agreement.",loading:'<img src="'+location.protocol+'//img.webmd.com/dtmcms/live/webmd/consumer_assets/site_images/modules/loading_small.gif" alt="Loading indicator"> Subscribing...',jsonError:'We\'re sorry: an error occurred. <a href="https://member.webmd.com/newsletters/newsletters.aspx" title="Subscribe to newsletters">Click here</a> for newsletters.',timeoutError:"This feature is temporarily unavailable. Please try again later.",success:"<strong>{email}</strong>, you're now signed up!"},init:function(e,t){var s=this,i=$(e),n=s.selectors;return t||(t={}),i.data(s.dataVar)?void 0:(i.data(s.dataVar,s),i=$(e).eq(0),s.nodes={$title:i.find(n.title),$text:i.find(n.text),$form:i.find(n.form),$inputNls:i.find(n.inputNls),$inputCbs:i.find(n.inputCbs),$inputEmail:i.find(n.inputEmail),$inputPrivacy:i.find(n.inputPrivacy),$submit:i.find(n.submit)},webmd.status&&webmd.status.reg===!1&&!webmd.cookie.exists("ignoremaint")&&s.nodes.$form.before('<div class="reg_down">This feature is currently unavailable.  The site is undergoing routine maintenance and will be back shortly.</div>').remove(),i.hasClass(s.classNoChange)||(t.title&&s.nodes.$title.html(t.title),t.text&&s.nodes.$text.html(t.text),t.nl&&s.nodes.$inputNls.val(t.nl)),s.nodes.$inputEmail.focus(function(){s.onFocus()}).blur(function(){s.onBlur()}).blur(),s.nodes.$inputPrivacy.click(function(){$(this).is(":checked")?$(this).removeClass("error"):$(this).addClass("error")}),s.nodes.$form.attr("onsubmit","").unbind("submit").submit(function(){return s.submit(),!1}),this)},submit:function(){var e,t,s,i,n,o;if(t=this,e=t.nodes.$form,s=e.data("timer"),s&&clearTimeout(s),t.validateForm()){t.displayLoading(),s=setTimeout(function(){t.displayMsg(t.msg.timeoutError,!0),t.nodes.$inputPrivacy.parent().remove(),"normal_email"!=t.nodes.$inputEmail.attr("id")&&t.nodes.$inputEmail.remove(),t.nodes.$submit.remove(),wmdPageLink("reg-error_l-nl")},1e3*t.timeoutSeconds),e.data("timer",s),o=t.nodes.$inputPrivacy.is(":checked")?1:0,i=t.data?t.data:{};for(var d in t.dataSelectors)$(t.dataSelectors[d],t.nodes.$form).each(function(){$(this).attr("name").length>0&&(i[$(this).attr("name")]=$(this).val())});i.email=t.nodes.$inputEmail.val(),i.privacy_policy_accept=o,i.nls="",t.nodes.$inputNls.length?(i.nls=t.nodes.$inputNls.val(),n=i.nls):t.nodes.$inputCbs.length&&t.nodes.$inputCbs.filter(":checked").each(function(){var e=$(this).val();i.nls&&(i.nls+=","),i.nls+=e,n=n||e}),t.transmitData(i),t.omnitureModule&&wmdPageLink(t.omnitureModule+"_"+n+t.omnitureAppend)}},transmitData:function(e){var t=this;$.getJSON(t.serviceUrl+"?callback=?",e,function(e){t.jsonResponse(e)})},jsonResponse:function(e){var t,s,i=this;s=i.nodes.$form.data("timer"),s&&clearTimeout(s),e&&e.d&&"success"===e.d.stat?(t=i.nodes.$inputEmail.val(),i.finish(i.msg.success.replace(/\{email\}/,webmd.htmlEncode(t))),3===e.d.code&&wmdPageLink("reg-success_l-nl")):(i.nodes.$text.addClass("newsletterError"),i.displayMsg(i.msg.jsonError,!0),wmdPageLink("reg-error_l-nl"))},validateForm:function(){var e,t,s;return e=this,e.nodes.$inputEmail.removeClass("error"),e.nodes.$inputPrivacy.removeClass("error"),t=e.nodes.$inputEmail.val(),s=e.nodes.$inputEmail.attr("title"),t.match(/\S/)&&t!==s?e.isEmail(t)?e.nodes.$inputCbs.length&&!e.nodes.$inputCbs.filter(":checked").length?(e.displayMsg(e.msg.checkbox,!0),!1):e.nodes.$inputPrivacy.length&&!e.nodes.$inputPrivacy.filter(":checked").length?(e.displayMsg(e.msg.privacy,!0),e.nodes.$inputPrivacy.addClass("error"),!1):!0:(e.displayMsg(e.msg.badEmail,!0),e.nodes.$inputEmail.focus().addClass("error"),!1):(e.displayMsg(e.msg.noEmail,!0),e.nodes.$inputEmail.focus().addClass("error"),!1)},onFocus:function(){var e,t,s;e=this,t=e.nodes.$inputEmail,s=t.attr("title"),t.removeClass(e.classes.label),s&&t.val()===s&&t.val("")},onBlur:function(){var e,t,s;e=this,t=e.nodes.$inputEmail,s=t.attr("title"),s&&!t.val().match(/\S/)&&(t.val(s),t.addClass(e.classes.label))},displayLoading:function(){this.nodes.$form.hide(),this.nodes.$text.removeClass("newsletterError"),this.displayMsg(this.msg.loading,!1)},displayMsg:function(e,t){var s=this,i=s.nodes.$text;i.hide(),e?0==t?i.html(e).fadeIn("slow"):i.html(e).toggleClass(s.classes.error,t).fadeIn("slow"):i.html("").removeClass(s.classes.error).fadeOut("slow")},finish:function(e){this.nodes.$form.hide(),this.nodes.$text.removeClass("newsletterError"),this.displayMsg(e,!1)},isEmail:function(e){var t=RegExp("^\\s*[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,4}\\s*$","i");return t.test(e)},getAPI_url:function(){this.serviceUrl=webmd.substitute(this.serviceUrl,{environment:webmd.url.getEnv()})}};